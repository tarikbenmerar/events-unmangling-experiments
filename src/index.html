<!DOCTYPE html>
<html>
<head>
	<title>Mangled Events Example</title>
	<link rel="stylesheet" type="text/css" href="css/style.css"/>
	<script type="text/javascript" src="js/lodash.underscore.js"></script>
	<script type="text/javascript" src="js/jquery-1.11.1.js"></script>
</head>
<body>
<h1>Mangled Events Example</h1>
<div class="root_element" tabindex="0" role="widget">
	<div><input class="input" type="text" /></div>
	<div class="switch_button"><button tabindex="-1">=</button></div>
	<ul class="items">
		<li>item1</li>
		<li>item2</li>
		<li>item3</li>
		<li>item4</li>
	</ul>
</div>
<script>
	//Prioritised throttling
	var prioritisedThrottle = function ( func, priorities, timeout ) {
		var currentPriority = undefined,
			context,
			flushPriority = _.throttle(function () {
				currentPriority = undefined;
			}, timeout, {leading: false, trailing: true} ),
			throttledFunc = _.throttle(function () {
				func.apply( context, arguments );
			}, timeout, {leading: false, trailing: true} );

		return function ( priority  ) {
			//Set the function context
			context = context || this;

			if( currentPriority !== undefined ) {
				if( priorities[ priority ] > currentPriority ) {
					throttledFunc( priority );
					currentPriority = priorities[ priority ];
				}
			} else {
				throttledFunc( priority );
				currentPriority = priorities[ priority ];

			}

			//Flush the priority
			flushPriority();
		}
	}

	//Widget
	var widget = {
		init: function () {
			var self = this;

			var itemsEl = $('.items'),
				inputEl = $('.input');

			//Put the input element on root element focus
			this.rootEl.focus(function () {
				self.onRootElFocus();
			});

			//Display items on input element focus
			this.inputEl.focus(function () {
				self.onInputElFocus();
			});

			//Hide the items, on root element focusout
			this.rootEl.focusout(function ( e ) {
				self.onRootElFocusOut();
			});

			//Switching items element display on click
			this.switchBtn.click(function () {
				self.onSwitchBtnClick();
			});

			//Preventing mousedown to avoid a bug
			this.switchBtn.mousedown(function ( e ) {
				e.preventDefault();
			})

			this.setRootElOutline = _.throttle( this.setRootElOutline, 20, {leading: false, trailing: true} );

			this.handleItemsDisplay = prioritisedThrottle( this.handleItemsDisplay, {focusout: 0, click: 1, focus: -1}, 20 );
		},

		rootEl: $( '.root_element' ),
		switchBtn: $( '.switch_button' ),
		itemsEl: $('.items'),
		inputEl: $('.input'),
		onSwitchBtnClick: function () {
			this.handleItemsDisplay( 'click' );

			//Put the root element on focus
			this.rootEl.focus();

			//Log the event
			console.log('Switch button down');
		},

		handleItemsDisplay: function ( event ) {
			if( event === 'click' ) {
				var itemsEl = this.itemsEl;
				if( itemsEl.css('display') === 'block' ) {
					this.setItemsDisplay( 'none' );
				} else {
					this.setItemsDisplay( 'block' );
				}
			} else if( event === 'focusout' ) {
				this.setItemsDisplay( 'none' );
			} else {
				this.setItemsDisplay( 'block' );
			}
		},

		setItemsDisplay: function ( display ) {
			console.log(display);
			this.itemsEl.css('display', display);
		},

		setRootElOutline: function ( outline ) {
			console.log(outline);
			this.rootEl.css('outline', outline );
		},

		onFocus: function () {
			this.setRootElOutline( 'blue dotted' );
		},

		onInputElFocus: function () {
			this.handleItemsDisplay( 'focus' );
			this.onFocus();
		},

		onRootElFocus: function () {
			this.inputEl.focus();
			this.onFocus();
		},

		onRootElFocusOut: function () {
			this.setRootElOutline( 'none' );
			this.handleItemsDisplay( 'focusout' );
		},
	}
	$(function () {
		//Init the widget
		widget.init();
	});
</script>

</body>
</html>